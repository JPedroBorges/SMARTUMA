import{pluckNumber,stubFN,BLANKSTRING,parseTooltext}from'../_internal/lib/lib';import{convertColor,getLightColor}from'../_internal/lib/lib-graphics';let DRILLUP='drillup',id=1,afAPICreator=function(e,t){function i(e,t){let i=e.range;return!i||!!(i.min<=t&&t<=i.max)}function a(e){h=e}function o(){return h}function l(i,o,l,r){function n(e){var t,i,a={};for(t in y)i=y[t],a[i]=e[t];return a}var h,s,g,d=o.getFromEnv('chart'),c=o.getFromEnv('toolbarBtns'),p=o.conf,f=i.drawTree,v=r.disposeChild,b=e.context,u=arguments,y={colorValue:'svalue',label:'name',value:'value',rect:'metrics'};return s=b.getInstance('ClickedState'),d._intSR={},d._intSR.backToParent=h=function(t){var a=this,n=a,s=n&&a.getParent(),c=e.context,b=c.getInstance('ClickedState'),y=b.get('VisibileRoot')||{};d.config.trackerConfig.length=0,d.triggerKDTreePartioning(),t?d.fireChartInstanceEvent('beforedrillup',{node:a,withoutHead:!p.showParent},void 0,function(){s&&(y.state=DRILLUP,y.node=[{virginNode:e.getVisibleRoot()},s],v(n),f.apply(s,u)),d.fireChartInstanceEvent(DRILLUP,{node:a,withoutHead:!p.showParent,drillUp:h,drillUpToTop:g}),a=a&&a.getParent()},function(){d.fireChartInstanceEvent('drillupcancelled',{node:a,withoutHead:!p.showParent})}):(s&&(y.state=DRILLUP,y.node=[{virginNode:e.getVisibleRoot()},s],v(n),f.apply(s,[i,o,l,r])),a=a&&a.getParent())},d._intSR.resetTree=g=function(t){var i,a=this,o=a&&a.getParent(),l=e.context,r=l.getInstance('ClickedState'),n=r.get('VisibileRoot')||{};for(d.config.trackerConfig.length=0,d.triggerKDTreePartioning();o;)i=o,o=o.getParent();t?d.fireChartInstanceEvent('beforedrillup',{node:a,withoutHead:!p.showParent},void 0,function(){i&&(n.state=DRILLUP,n.node=[{virginNode:e.getVisibleRoot()},i],v(i),f.apply(i,u),d.fireChartInstanceEvent(DRILLUP,{node:a,sender:d.fusionCharts,withoutHead:!p.showParent,drillUp:h,drillUpToTop:g}))},function(){d.fireChartInstanceEvent('drillupcancelled',{node:a,withoutHead:!p.showParent})}):i&&(n.state=DRILLUP,n.node=[{virginNode:e.getVisibleRoot()},i],v(i),f.apply(i,u))},{click:function(e,i){var o,l,f,b=e.virginNode,u=d.getFromEnv('animationManager');if(d.state='click',d.fireChartInstanceEvent('dataplotclick',n(e.virginNode)),l=b.getParent(),!!l){if(b===i)f=l,d.flushKDTree(),d.config.trackerConfig.length=0,o=DRILLUP;else if(b.next)f=b,d.flushKDTree(),d.config.trackerConfig.length=0,o='drilldown';else{if(f=l,i===f)return void(o=void 0);d.config.trackerConfig.length=0,o='drilldown'}o&&d.fireChartInstanceEvent('before'+o,{node:f,withoutHead:!p.showParent},void 0,function(){s.set('VisibileRoot',{node:e,state:o}),v.call(r,f),a(f),u.setAnimationState('drill'),d.setState('drill',!0),t.draw(),u.onAnimationComplete(()=>{d.setState('drill',!1)}),d.fireChartInstanceEvent(o,{node:f,withoutHead:!p.showParent,drillUp:h,drillUpToTop:g})},function(){d.fireChartInstanceEvent(o+'cancelled',{node:f,withoutHead:!p.showParent})}),c.back&&c.back.attachEventHandlers({click:h.bind(f)}),c.home&&c.home.attachEventHandlers({click:g.bind(f)}),d.resetSingleTracker()}},mouseover:function(e){var t=n(e.virginNode);d.fireChartInstanceEvent('dataplotrollover',t,void 0,void 0,function(){d.fireChartInstanceEvent('dataplotrollovercancelled',t)})},mouseout:function(e){var t=n(e.virginNode);d.fireChartInstanceEvent('dataplotrollout',n(e.virginNode),void 0,void 0,function(){d.fireChartInstanceEvent('dataplotrolloutcancelled',t)})}}}var r,n,h,s,g;return r=function(e,t){var i,a,o={},l=t&&t.exception;class r{constructor(e){this.iterAPI=e}initWith(e){return this.iterAPI(e)}}return o.df=function(e){var t,i,a=e,o=[],r=!1;return o.push(a),t=function(e){var t,i,a;if(!r)return(i=o.shift(),l&&i===l&&(i=o.shift(),!i))?void(r=!0):(t=void 0===e?i.getChildren():i.getDepth()>=e?[]:i.getChildren(),a=t&&t.length||0,a&&[].unshift.apply(o,t),0===o.length&&(r=!0),i)},i=function(){r=!1,a=e,o.length=0,o.push(a)},{next:t,reset:i}},o.bf=function(e){var t,i,a,o=e,l=[],r=[],n=!1;return l.push(o),r.push(o),t=function(){var e,t,i;if(!n)return t=l.shift(),e=t.getChildren(),i=e&&e.length||0,i&&[].push.apply(l,e),0===l.length&&(n=!0),t},i=function(){var e,t,i;if(!n)return t=r.shift(),e=t.getChildren(),i=e&&e.length||0,i&&[].push.apply(r,e),0===l.length&&(n=!0),e},a=function(){n=!1,o=e,l.length=0,l.push(o)},{next:t,nextBatch:i,reset:a}},i=new r(o.df).initWith(e),a=new r(o.bf).initWith(e),{df:i,bf:a}},g=function(){function e(){this.con={}}var t,i={};return e.prototype.constructor=e,e.prototype.get=function(e){return this.con[e]},e.prototype.set=function(e,t){this.con[e]=t},e.prototype['delete']=function(e){return delete this.con[e]},{getInstance:function(a){var o;return i[a]?(o=i[a],t=o,t):(t=o=i[a]=new e,t)}}}(),s=function(){var e,t=[],i=!1,a={visibility:'visible',opacity:1};return{controlPreAnimVisibility:function(a,o){var l,n,h,s,g,d;if(a){for(n=a;n=n.getParent(),!!n;)l=n;for(h=r(l,{exception:a}),s=h.df;g=s.next(),!!g;)d=g.overAttr||(g.overAttr={}),d.visibility='hidden',t.push(g);return e=o||a.getParent(),i=!1,t}},displayAll:function(a){var o,l,n,h;if(a){for(o=r(a.getParent()||a),n=o.df;h=n.next(),!!h;)l=h.overAttr||(h.overAttr={}),l.visibility='visible';e=void 0,t.length=0,i=!1}},controlPostAnimVisibility:function(){var o,l,h,s,g;if(!i&&(i=!0,!!e)){for(h=r(e),s=h.df;g=s.next(n),!!g;)g.dirtyNode&&(l=g.dirtyNode,l&&l.plotItem.attr(a),o=l&&l.textItem,o&&o.label&&o.label.attr(a),o&&o.label&&o.highlightMask.attr(a));e=void 0,t.length=0}}}}(),e.AbstractTreeMaker=class{constructor(e,t,i){this.node=e,this.bucket=t?new Bucket:void 0,this.cleansingFn=i}get(){var e=this.order,t=this.bucket,i=this.cleansingFn;return function a(o,l){var r,n,h,s,g,d,c=['label','value','data','svalue'];if(o)for(d in r=new TreeNode(o.label,i(o.value),i(o.svalue)),h=o.data||[],0===h.length&&t&&t.addInBucket(r),r.setDepth(l),o)-1===c.indexOf(d)&&r.setMeta(d,o[d]);for(e&&(h=e(h)),n=0;n<h.length;n++)s=h[n],g=a(s,l+1),r.addChild(g);return r}(this.node,0)}getBucket(){return this.bucket}static getMaxDepth(){return n}},e.iterator=r,e.initConfigurationForlabel=function(e,t,i){var a=e.x,o=e.y,l=t/2,r=i.showParent?0:1,h=i.showChildLabels;return function(e,s,g){var d,c,p,f=!1,v={x:void 0,y:void 0,width:void 0,height:void 0},b={},u=0,y={},m={};if(p=e.meta,!!e)return e.isLeaf(n)||(f=!0),b.label=e.getLabel(),v.width=s.width-2*a,v.x=s.x+s.width/2,c=s.height-2*o,!f&&c<t&&(v.height=-1),!g&&f?(v.height=h?v.height?v.height:s.height-2*o:-1,v.y=s.y+s.height/2):r?(v.y=-1,o=0,t=0,d='hidden'):(v.height=v.height?v.height:t,v.y=s.y+o+l),u+=2*o,u+=t,b.rectShiftY=u,b.textRect=v,i.labelGlow?(m['stroke-width']=i.labelGlowRadius,m.opacity=i.labelGlowIntensity,m.stroke=i.labelGlowColor,m.visibility='hidden'===d?'hidden':'visible'):m.visibility='hidden',y={fontSize:i.labelFontSize||i.baseFontSize,fontFamily:i.labelFont||i.baseFont,fill:p&&p.fontcolor&&normalizeColorCode(p.fontcolor)||i.labelFontColor||i.baseFontColor,fontWeight:i.labelFontBold&&'bold',fontStyle:i.labelFontItalic&&'italic',visibility:d},{conf:b,attr:y,highlight:m}}},e.context=g,e.mapColorManager=function(e,t,a){var o=normalizeColorCode(a?e.defaultNavigationBarBGColor:e.defaultParentBGColor);return function(a,l,r){var h,s,g,d={},c=a.cssConf,p=a.meta,f=p.fillcolor?normalizeColorCode(p.fillcolor):void 0,v=a.getParent(),b=a.getColorValue();return e.isLegendEnabled=!0,a.presentColor=e.isLegendEnabled&&b?t&&t.getColorByValue(b)?i(r,b)?'#'+t.getColorByValue(b):normalizeColorCode(r.rangeOutBgColor):normalizeColorCode(t&&t.rangeOutsideColor):void 0,f&&(a.presentColor=f),g=e.isLegendEnabled&&b?t&&t.getColorByValue(b)&&'#'+t.getColorByValue(b)||normalizeColorCode(t&&t.rangeOutsideColor):void 0,a.isLeaf(n)?d.fill=f||g||o:(s=(v||a).cssConf,h=s&&s.fill,g=g||h,d.fill=f||g),d.stroke=l?e.navigationBarBorderColor:e.plotBorderColor,d.strokeWidth=l?e.navigationBarBorderThickness:e.plotBorderThickness,d['stroke-dasharray']='none',!l&&c&&'--'===c['stroke-dasharray']&&(d['stroke-dasharray']=c['stroke-dasharray'],d.strokeWidth=c.strokeWidth),d}},e.abstractEventRegisterer=l,e.setMaxDepth=function(e){return n=e},e.getVisibleRoot=o,e.setVisibleRoot=a,e.visibilityController=s,e},algorithmFactoryCreator=function(e,t){function a(e){let t,o=e.getChildren(),l=0;for(let r=0;r<(o&&o.length);r++)t=o[r],a(t),l+=t.getValue()||0;isNaN(e.value)&&(e.value=l)}function i(t,i,a){return s=t,c=i,p=e.setMaxDepth(a),h[s]}function o(e,t){var i,a,o=h[s];return a=o.applyShadeFiltering(g.getBucket(),e,t),function(e){i=Array.prototype.slice.call(arguments,0),i.unshift(e),a.apply(g.getBucket(),i)}}function l(t,i,a){var o;return g=new b(t,c,i),o=g.get(),!1!==a&&(d=o),e.setVisibleRoot(o),o}function r(){var i,a=h[s];t.realTimeUpdate=n.apply(this,arguments),i=Array.prototype.slice.call(arguments,0),i.unshift(a),a.drawTree.apply(e.getVisibleRoot(),i)}function n(){var e,t,i=h[s];return t=Array.prototype.slice.call(arguments,0),t.unshift(i),e=t.slice(-1)[0],function(){var a=Array.prototype.slice.call(arguments,0),o=a.shift(),l=a.shift(),r=treeOpt(d,function(e){i.drawTree.apply(e||d,t)},e,o);r[l].apply(this,a)}}var h,s,g,d,c,p,f,v=e.AbstractTreeMaker;h={sliceanddice:{areaBaseCalculator:function(e,t){var i=e,a=t;return function(e,t,o){var l,r,n,h,s,g,d={},c=0,p=0;if(e)return o&&(c=o.textMargin||c),p=c,l=e.getParent(),r=e.getSibling('left'),l?(n=l.getValue(),g=l.rect,h=g.height-2*a-p,s=g.width-2*i,d.effectiveRect={height:h,width:s,x:g.x+i,y:g.y+a+p},d.effectiveArea=h*s,d.ratio=e.getValue()/n,r?t.call(e,d,r,l):(d.lastIsParent=!0,t.call(e,d,l))):null}},applyShadeFiltering:function(e,t,i){return e.setRangeOutEffect(t,i),this.applyShadeFiltering.reset=function(){e.resetPointers()},function(t){e.moveLowerShadePointer(t.start),e.moveHigherShadePointer(t.end)}},alternateModeManager:function(){return function(e,t){var i,a,o,l,r,n=this,h=e.effectiveArea,s=e.ratio,g=h*s,d=e.effectiveRect,c=t.rect,p=e.lastIsParent;return p?(l=d.x,r=d.y,i=d.height,a=d.width,o=n.isDirectionVertical=!0):(i=d.height+d.y-(c.height+c.y),a=d.width+d.x-(c.width+c.x),o=n.isDirectionVertical=!t.isDirectionVertical),o?(a=g/i,l=void 0===l?c.x:l,r=void 0===r?c.y+c.height:r):(i=g/a,l=void 0===l?c.x+c.width:l,r=void 0===r?c.y:r),{height:i,width:a,x:l,y:r}}},horizontalVerticalManager:function(e){return function(t,i){var a,o,l,r,n,h=this,s=t.effectiveArea,g=t.ratio,d=s*g,c=t.effectiveRect,p=i.rect,f=t.lastIsParent;return f?(r=c.x,n=c.y,a=c.height,o=c.width,l=h.isDirectionVertical=!i.isDirectionVertical):(a=c.height+c.y-(p.height+p.y),o=c.width+c.x-(p.width+p.x),l=h.isDirectionVertical=!arguments[2].isDirectionVertical),l='vertical'===e?l:!l,l?(0===a&&(a=c.height,r=void 0===r?p.x+p.width:r,n=void 0===n?p.y:n),o=d/a,r=void 0===r?p.x:r,n=void 0===n?p.y+p.height:n):(0===o&&(o=c.width,r=void 0===r?p.x:r,n=void 0===n?p.y+p.height:n),a=d/o,r=void 0===r?p.x+p.width:r,n=void 0===n?p.y:n),{height:a,width:o,x:r,y:n}}},drawTree:function(t,i,o,l){var r,n,h,s,g,d,c,v,b,u=this,y=i.getFromEnv('chart'),m=y.config||(y.config={}),x=m.trackerConfig||(m.trackerConfig=[]),w=i.getFromEnv('number-formatter'),C=i.getFromEnv('toolbarBtns'),k=l.drawRect,P=l.drawText,I=l.drawHot,V=o.horizontalPadding,_=o.verticalPadding,S=i.getFromEnv('smartLabel'),R={x:5,y:5},F=e.iterator,A=F(u),E=A.df,T=t.areaBaseCalculator(V,_),H=i.conf,B=H.highlightParentsOnHover,N=e.context,M=e.visibilityController,L=i.conf.colorRange,D=e.mapColorManager(H,L),O=e.abstractEventRegisterer(t,i,o,l),z=O.click,W=O.mouseover,Y=O.mouseout,U=H.slicingMode,G='alternate'===U?'alternateModeManager':'horizontalVerticalManager',X=t[G](U),K=y._intSR;for(c=N.getInstance('ClickedState'),v=c.get('VisibileRoot')||{},b=v.node,v.node&&v.state&&(v.state.toLowerCase()===DRILLUP?b instanceof Array?M.controlPreAnimVisibility(b[0].virginNode,b[1]):M.controlPreAnimVisibility(b.virginNode):M.displayAll(v.node.virginNode)),r=H.parentLabelLineHeight,h=e.initConfigurationForlabel(R,r,H),n=E.next(f=e.setMaxDepth(u.getDepth()+p)),s=n;s.getParent();)s=s.getParent();m.valuesset||a(s),m.valuesset=!0,H.showNavigationBar?(C.home.hide(),C.back.hide()):s==n?(C.home.hide(),C.back.hide()):(C.home.show(),C.back.show()),S.useEllipsesOnOverflow(y.config.useEllipsesWhenOverflow),S.setStyle(H._setStyle={fontSize:(H.labelFontSize||H.baseFontSize)+'px',fontFamily:H.labelFont||H.baseFont,lineHeight:1.2*(H.labelFontSize||H.baseFontSize)+'px'}),d=K.backToParent,g=K.resetTree,C.back&&C.back.attachEventHandlers({click:d.bind(n)}),C.home&&C.home.attachEventHandlers({click:g.bind(n)}),function e(t,a){var o,r,s,g,d,c,p,v,b,u,y,m,C,V,_,R,F={},A={},M={},L={},O='';t&&t.value&&(_=w.yAxis(t.getValue()),R=w.sYAxis(t.getColorValue()),t.setPath(),r=t.rect||{},s=t.textRect||{},b=t.rect={},u=t.textRect={},b.width=a.width,b.height=a.height,b.x=a.x,b.y=a.y,L=D(t,void 0,i.conf),V=t.plotItem,V&&l.graphicPool(!0,'plotItem',V,r),t.__props||(t.__props={}),t.__props.curr=Object.assign({},b),t.__props.node=Object.assign({},t),V=t.plotItem=k(b,Object.assign({},L,t.getColorValue()&&{fill:t.presentColor}||{}),r,t.overAttr,t),t.__props.prev=Object.assign({},b),t.cssConf=L,y=h(t,b),m=y.conf,F.textMargin=m.rectShiftY,u=t.textRect=m.textRect,C=S.getSmartText(m.label,u.width,u.height).text,t.plotItem=V,d=t.labelItem,d?(c=t.highlightItem,l.graphicPool(!0,'labelItem',d,r),l.graphicPool(!0,'highlightItem',c,r)):s=s||{},p=P(C,u,{textAttrs:y.attr,highlightAttrs:y.highlight},s,t.overAttr,t),t.labelItem=p.label,t.highlightItem=p.highlightMask,A.virginNode=t,A.plotItem=V,A.textItem=p,A.virginNode.dirtyNode=A,t.getColorValue()&&(O=H.tooltipSeparationCharacter+R),A.toolText=H.showTooltip?parseTooltext(H.plotToolText,[1,2,3,119,122],{label:t.getLabel(),formattedValue:_,formattedsValue:R},{value:t.getValue(),svalue:t.getColorValue()})||t.getLabel()+H.tooltipSeparationCharacter+_+O:BLANKSTRING,A.rect=b,M.hover=[function(e){var t,i,a,o,l,r,n=this;o=N.getInstance('hover'),a=n.virginNode,B&&!a.next?(t=a.getParent(),i=t||a):i=n.virginNode,o.set('element',i),l=i.cssConf,r=convertColor(getLightColor(l.fill,80),60),e.attr({fill:r}),W(this)}.bind(A),function(){var e,t,i,a;e=N.getInstance('hover'),t=e.get('element'),i=t.cssConf,a=convertColor(i.fill||'#fff',0),t.plotItem.tracker.attr({fill:a}),Y(this)}.bind(A)],M.tooltip=[A.toolText],M.click=[function(){z(this,n)}.bind(A)],g=t.hotItem,g&&l.graphicPool(!0,'hotItem',g,r),x.push({node:t,key:'hotItem',plotDetails:A,evtFns:M,callback:I}),o=E.next(f),v=T(o,X,F),e(o,v))}(n,o)}},squarified:{orderNodes:function(){return this.sort(function(e,t){return parseFloat(e.value,10)<parseFloat(t.value,10)?1:-1})},areaBaseCalculator:function(e,t){var i=e,a=t;return function(e,t,o){var l,r,n,h,s,g={},d=0,c=0;if(e&&0!==e.length)return o&&(d=o.textMargin||d),c=d,h=e[0],l=h.getParent(),l?(s=l.rect,r=s.height-2*a-c,n=s.width-2*i,g.effectiveRect={height:r,width:n,x:s.x+i,y:s.y+a+c},g.effectiveArea=r*n,t.call(h,g,l)):null}},layoutManager:function(){return{RowLayout:class{constructor(e,t){this.totalValue=t,this._rHeight=e.height,this._rWidth=e.width,this._rx=e.x,this._ry=e.y,this._rTotalArea=e.height*e.width,this.nodes=[],this._prevAR=void 0,this._rHeight<this._rWidth&&(this._hSegmented=!0)}addNode(e){var t,a,o,l,r,n,h,s,g,d,c,p,f,v,b,u,y,m,x,w,C,k=this._rTotalArea,P=this._hSegmented,I=this._rx,V=this._ry,_=0;for(this.nodes.push(e),r=0,h=this.nodes.length;r<h;r++)_+=parseFloat(this.nodes[r].getValue(),10);for(a=_/this.totalValue,t=k*a,P?(l=this._rHeight,o=t/l,f=I+o,v=V,u=this._rHeight,y=this._rWidth-o):(o=this._rWidth,l=t/o,f=I,v=V+l,u=this._rHeight-l,y=this._rWidth),(r=0,n=this.nodes.length);r<n;r++)e=this.nodes[r],s=e.getValue(),g=s/_*t,e.hRect=e.rect||{},e._hRect=e._rect||{},p=e.rect={},P?(p.width=c=o,p.height=d=g/c,p.x=I,p.y=V,V+=d):(p.height=d=l,p.width=c=g/d,p.x=I,p.y=V,I+=c),m=Math.max(p.height,p.width),x=Math.min(p.height,p.width),w=m/x,isFinite(w)||(w=0),e.aspectRatio=w;if(!(1<this.nodes.length))e&&(b=e._rect={},C=e.rect,b.width=C.width,b.height=C.height,b.x=C.x,b.y=C.y,e.firstPassed=!0);else if(this.prevAR<e.aspectRatio){for(this.nodes.pop().rect={},r=0,h=this.nodes.length;r<h;r++)this.nodes[r].rect=1===h&&this.nodes[r].firstPassed?this.nodes[r]._hRect:this.nodes[r].hRect,b=this.nodes[r]._rect={},C=this.nodes[r].rect,b.width=C.width,b.height=C.height,b.x=C.x,b.y=C.y;return!1}return this.prevAR=e.aspectRatio,this.height=l,this.width=o,this.getNextLogicalDivision=function(){return{height:u,width:y,x:f,y:v}},e}}}}(),applyShadeFiltering:function(e,t,i){return e.setRangeOutEffect(t,i),this.applyShadeFiltering.reset=function(){e.resetPointers()},function(t){e.moveLowerShadePointer(t.start),e.moveHigherShadePointer(t.end)}},drawTree:function(t,i,o,l){var r,n,h,s,g,d,c,v,b,u=this,y=i.getFromEnv('chart'),m=i.getFromEnv('chartConfig'),x=m.trackerConfig||(m.trackerConfig=[]),w=i.getFromEnv('number-formatter'),C=i.getFromEnv('toolbarBtns'),k={x:5,y:5},P=o.horizontalPadding,I=o.verticalPadding,V=t.areaBaseCalculator(P,I),_=t.layoutManager.RowLayout,S=i.getFromEnv('smartLabel'),R=l.drawRect,F=l.drawText,A=l.drawHot,E=e.iterator,T=E(u),H=T.bf,B=i.conf,N=B.highlightParentsOnHover,M=e.context,L=i.conf.colorRange,D=e.mapColorManager(B,L),O=e.abstractEventRegisterer(t,i,o,l),z=O.click,W=O.mouseover,Y=O.mouseout,U=y._intSR,G=e.visibilityController;for(c=M.getInstance('ClickedState'),v=c.get('VisibileRoot')||{},b=v.node,v.node&&v.state&&(v.state.toLowerCase()===DRILLUP?b instanceof Array?G.controlPreAnimVisibility(b[0].virginNode,b[1]):G.controlPreAnimVisibility(b.virginNode):G.displayAll(v.node.virginNode)),r=B.parentLabelLineHeight,h=e.initConfigurationForlabel(k,r,B),n=H.next(f=e.setMaxDepth(u.getDepth()+p)),s=n;s.getParent();)s=s.getParent();m.valuesset||a(s),m.valuesset=!0,B.showNavigationBar?(C.home.hide(),C.back.hide()):s==n?(C.home.hide(),C.back.hide()):(C.home.show(),C.back.show()),S.useEllipsesOnOverflow(y.config.useEllipsesWhenOverflow),S.setStyle(B._setStyle={fontSize:(B.labelFontSize||B.baseFontSize)+'px',fontFamily:B.labelFont||B.baseFont,lineHeight:1.2*(B.labelFontSize||B.baseFontSize)+'px'}),g=U.backToParent,d=U.resetTree,C.back&&C.back.attachEventHandlers({click:g.bind(n)}),C.home&&C.home.attachEventHandlers({click:d.bind(n)}),function e(t,a){var o,r,s,g,d,c,p,v,b,u,y,m,C,k,P,I,E,T,H={},L=0,O={},U={},G={},X={},K='';if(t&&t.value&&(E=w.yAxis(t.getValue()),T=w.sYAxis(t.getColorValue()),t.setPath(),o=t.__initRect,o&&(H.x=o.x,H.y=o.y,H.width=o.width,H.height=o.height),d=t.textRect||{},o=t.rect=t.__initRect={},c=t.textRect={},o.width=a.width,o.height=a.height,o.x=a.x,o.y=a.y,X=D(t,void 0,i.conf),C=t.plotItem,C&&l.graphicPool(!0,'plotItem',C,H),t.__props||(t.__props={}),t.__props.curr=Object.assign({},o),t.__props.node=Object.assign({},t),C=t.plotItem=R(o,Object.assign({},X,t.getColorValue()&&{fill:t.presentColor}||{}),H,t.overAttr,t),t.__props.prev=Object.assign({},o),t.cssConf=X,I=h(t,o),k=I.conf,O.textMargin=k.rectShiftY,c=t.textRect=k.textRect,P=S.getSmartText(k.label,c.width,c.height).text,g=t.labelItem,g?(r=t.highlightItem,l.graphicPool(!0,'labelItem',g,H),l.graphicPool(!0,'highlightItem',r,H)):d=d||{},v=F(P,c,{textAttrs:I.attr,highlightAttrs:I.highlight},d,t.overAttr,t),t.labelItem=v.label,t.highlightItem=v.highlightMask,t.plotItem=C,U.virginNode=t,U.plotItem=C,U.textItem=v,U.virginNode.dirtyNode=U,t.getColorValue()&&(K=B.tooltipSeparationCharacter+T),U.toolText=B.showTooltip?parseTooltext(B.plotToolText,[1,2,3,119,122],{label:t.getLabel(),formattedValue:E,formattedsValue:T},{value:t.getValue(),svalue:t.getColorValue()})||t.getLabel()+B.tooltipSeparationCharacter+E+K:BLANKSTRING,U.rect=o,G.hover=[function(e){var t,i,a,o,l,r,n=this;o=M.getInstance('hover'),a=n.virginNode,N&&!a.next?(t=a.getParent(),i=t||a):i=n.virginNode,o.set('element',i),l=i.cssConf,r=convertColor(l.fill&&getLightColor(l.fill,80),60),e.attr({fill:r}),W(this)}.bind(U),function(e){var t,i,a,o;t=M.getInstance('hover'),i=t.get('element'),a=i.cssConf,o=convertColor(a.fill||'#fff',0),e.attr({fill:o}),Y(this)}.bind(U)],G.tooltip=[U.toolText],G.click=[function(){z(this,n)}.bind(U)],s=t.hotItem,s&&l.graphicPool(!0,'hotItem',s,H),x.push({node:t,key:'hotItem',plotDetails:U,evtFns:G,callback:A}),p=void 0===f?t.getChildren():t.getDepth()>=f?void 0:t.getChildren(),!!p))for(y=V(p,function(e,t){var i,a,o,l,r,n=0,h=[];for(i=new _({width:e.effectiveRect.width,height:e.effectiveRect.height,x:e.effectiveRect.x,y:e.effectiveRect.y},t.getValue()),a=p.length;n++!==a;)o=p[n-1],l=i.addNode(o),!1===l?(r=i.getNextLogicalDivision(),i=new _(r,t.getValue()-L),n--):(L+=parseFloat(o.getValue(),10),h.push(o));return h},O),b=0,u=y.length;b<u;b++)m=y[b],e(m,m.rect)}(n,o)}}};class b extends v{static getName(){return'TreeMaker'}order(e){var t=h[s],i=t.orderNodes;return i?i.apply(e,[t]):e}}return t.init=i,t.plotOnCanvas=function(e,t){return d=l(e,t),r},t.applyShadeFiltering=o,t.setTreeBase=function(e){return e&&(d=e)},t.realTimeUpdate=n,t.makeTree=l,t},treeOpt=function(e,t,i,a){function o(t){var i,a=0,o=e;if(!t.length)return e;for(;o;){if(i=l.call(o,t[a]),a==t.length-1&&i)return r=i.getValue(),i;o=i,a+=1}}function l(e){var t,i,a,o=this,l=o.getChildren()||[],r=l.length,n=function(e){return e.toLowerCase().trim()};for(t=0;t<r;t+=1)if(a=l[t],n(a.label)===n(e)){i=a;break}return i}var r;return{deleteData:function(e,a){var l,n=o(e),h=l.iterator(n),s=h.df,g=n&&n.getParent(),d=n&&n.getSiblingCount('left'),c=g&&g.getChildren(),p=l.getVisibleRoot();if(n&&g){for(c.splice(d,1),n===p&&(p=n.getParent()||p);n;)i.disposeItems(n),n=s.next();for(;g;)g.setValue(-r,!0),g=g.getParent();a&&t(p)}},addData:function(e,i,l,r){for(var n,h,s,g,d,c,p=0,f=!0,v=n.getVisibleRoot();e.length;)if(s=e.pop(),g=h.makeTree(s,a,!1),p=g.getValue(),d=o(i||[]),!!d)for(d.getChildren()||(c=d.getValue(),f=!1),d.addChildren(g,r);d;)d.setValue(p,f),c&&(p-=c,c=void 0,f=!0),d=d.getParent();l&&t(v)}}},containerManagerCreator=function(e,t){function i(){var e,t=['navigationBar','treeMap','stackedNavigation'],i=Array.prototype.slice.call(arguments,0);for(s=i[0],d=i[1],c=s.conf,p=i[2],g=i[4],f.get().length>=t.length&&f.set();t.length;)e=t.shift(),f.set({type:e,drawFn:u(e),drawingArea:w(e)})}function a(){return e.getVisibleRoot()}function o(t){var i=c.plotBorderThickness;!1,g.apply(e.getVisibleRoot(),[s,{width:t.effectiveWidth,height:t.effectiveHeight,x:t.startX,y:t.startY,horizontalPadding:c.horizontalPadding,verticalPadding:c.verticalPadding},p]),c.plotBorderThickness=i}function l(e,t,i){var a=e.x,o=e.y,l=e.width,r=e.height,n=c.seperatorAngle/2,h=pluckNumber(n?r/2*(1-Math.tan(n)):i,15),s=['M',e._x,o],g=function(e){return{both:['h',e,'v',r/2,'v',r/2,'h',-e,'v',-r/2,'v',-r/2],right:['h',e,'v',r/2,'v',r/2,'h',-e,'l',h,-r/2,'l',-h,-r/2],no:['h',e,'l',h,r/2,'l',-h,r/2,'h',-e,'l',h,-r/2,'l',-h,-r/2],left:['h',e,'l',h,r/2,'l',-h,r/2,'h',-e,'v',-r/2,'v',-r/2]}};return{path:['M',a,o].concat(g(l)[t]),_path:s.concat(g(e._width).both),offset:h}}function r(){var e=Array.prototype.splice.call(arguments,0);e.push(!0),u('navigationBar').apply(this,e)}function n(){var t=e.getVisibleRoot();t&&p.disposeChild(t)}function h(a){var o,l,r,n=e.getVisibleRoot();for(p.disposeSelectedChildren(n,a?a[1]:n),a&&(n=a[1]),n.getParent()?c.showNavigationBar&&t.heightProportion.set(!0):t.heightProportion.set(!1),l=f.get(),o=0;o<l.length;o+=1)r=l[o],r.setDrawingArea(w(r.conf.name)),a&&e.setVisibleRoot(a[o]),r.draw();p.hideNodes()}var s,g,d,c,p,f,v=Math.max,b=function(o,r){var n,h,g,f,b,u,m,w,C,k,P,I,V=c.colorRange,_=e.mapColorManager(c,V,!0),S=function(e){var t=a();n=e?t.getChildren():c.navigationBarNodes=t.getPath()||[].concat(t),n.pop(),h=n.length},R=function(){var e;return{get:function(t,i,a){var o={y:t.startY,height:t.effectiveHeight},l=n[i],r=l.getParent();return e?(o._x=t.startX+t.effectiveWidth,o._width=0):(o._x=t.startX,o._width=t.effectiveWidth),o.x=e||(e=t.startX),e+=a?o.width=t.effectiveWidth*(l.getValue()/r.getValue()):o.width=t.effectiveWidth/h,o},resetAllocation:function(){e=void 0}}}(),F=function(e,t){var i;return i=1===t?'both':0===e?'left':e<t-1?'no':'right',i},A=c.parentLabelLineHeight,E=e.initConfigurationForlabel({x:5,y:5},A,c),T=p.drawPolyPath,H=p.drawText,B=p.drawHot,N={navigationHistory:{path:'polyPathItem',label:'pathlabelItem',highlightItem:'pathhighlightItem',hotItem:'pathhotItem'}},M=s.getFromEnv('chart'),L=M.config.trackerConfig,D=s.getFromEnv('smartLabel'),O=function(i){return function(){var a=e.context,o=M.getFromEnv('animationManager'),l=a.getInstance('ClickedState'),r=l.get('VisibileRoot')||{};L.length=0,r.state=DRILLUP,r.node=[{virginNode:e.getVisibleRoot()},i],p.disposeChild(i),o.setAnimationState('drill'),M.setState('drill',!0),t.draw([i,i,i]),o.onAnimationComplete(()=>{M.setState('drill',!1)}),M.resetSingleTracker()}},z=function(){return function(){}},W=function(){return function(){}},Y=function(e){return c.showTooltip?e.getLabel():BLANKSTRING},U=c._setStyle,G=y.get().navigationBar,X=2*x('navigationBar'),K=G*d.effectiveHeight,q=Math.min(K-(X+6),U.fontSize.replace(/\D+/g,'')),J=q+'px';for(N.stacked={path:'stacked'+N.navigationHistory.path,label:'stacked'+N.navigationHistory.label,highlightItem:'stacked'+N.navigationHistory.highlightItem,hotItem:'stacked'+N.navigationHistory.hotItem},R.resetAllocation(),S(r),D.setStyle({fontSize:J,lineHeight:J}),g=0;g<h;g+=1)u=n[g],m=R.get(o,g,r),f=(b=l(m,r?'both':F(g,h),void 0,u)).offset,u[N[r?'stacked':'navigationHistory'].path]=T(b,_(u,!0,c),u),w=E(u,m,!0),k=w.conf,I=k.textRect,I.width-=2*f,I.y=m.y+m.height/2,C=D.getSmartText(k.label,I.width,v(q,I.height)).text,P=H(C,I,{textAttrs:w.attr,highlightAttrs:w.highlight},{y:m.height/10,"font-size":c._setStyle.fontSize,"font-family":c._setStyle.fontFamily},(r?'stacked':'')+'path',u),u[N[r?'stacked':'navigationHistory'].label]=P.label,u[N[r?'stacked':'navigationHistory'].highlightItem]=P.highlightMask,L.push({node:u,key:N[r?'stacked':'navigationHistory'].hotItem,plotDetails:{rect:m},evtFns:{click:[O(u,r)],hover:[z(u),W()],tooltip:[Y(u)]},callback:B})},u=function(e){return{treeMap:o,navigationBar:b,stackedNavigation:r}[e]},y=function(){var e={treeMap:1,navigationBar:0,stackedNavigation:0};return{set:function(t){var i,a=pluckNumber(c.navigationBarHeightRatio,c.navigationBarHeight/d.effectiveHeight,.15),o=c.labelFontSize?v(c.labelFontSize,c.baseFontSize):c.baseFontSize,l=2*x('navigationBar');i=(6+o+l)/d.effectiveHeight,a=v(i,a),.1>a?a=.1:.15<a&&(a=.15),c.navigationBarHeightRatio=a,e=t?{treeMap:1-a,navigationBar:a,stackedNavigation:0}:{treeMap:1,navigationBar:0,stackedNavigation:0}},get:function(){return e}}}(),m=0,x=function(e){var t=c.verticalPadding,i=c.plotBorderThickness,a=c.navigationBarBorderThickness;return t+('navigationBar'===e?a:i)},w=function(e){var t=Math.round,i=d.effectiveWidth,a=d.effectiveHeight,o=x(e),l=y.get(),r=l[e];return 1<=m&&(m=0),m+=r,{effectiveHeight:t(100*(r*a))/100-o,effectiveWidth:i,startX:d.startX,startY:d.startY+o+t(100*((m-r)*a))/100}};class C{init(e,t){var i=this,a=i.conf||(i.conf={});a.name=e.name,i.setDrawingArea(e.drawingAreaMeasurement),i.draw=i.draw(t)}setDrawingArea(e){var t=this.conf;t.drawingAreaMeasurement=e}draw(e){return function(){var t=this.conf,i=t.drawingAreaMeasurement;0<i.effectiveHeight&&e(t.drawingAreaMeasurement)}}eventCallback(){}}return f=function(){var e=[];return{get:function(){return e},set:function(t){var i;return t?(i=new C,i.init({name:t.type,drawingAreaMeasurement:t.drawingArea},t.drawFn),e.push(i)):e.length=0,e}}}(),t.init=i,t.draw=h,t.heightProportion=y,t.remove=n,t},normalizeColorCode=function(e){return e?e.replace(/^#*/,'#'):'#'+MOTHER_OF_ALL_COLOR},MOTHER_OF_ALL_COLOR='E5E5E5',ref=function(){var e={},t={};return{afAPI:afAPICreator(e,t),algorithmFactory:algorithmFactoryCreator(e,{},t),containerManager:containerManagerCreator(e,t),treeOpt:treeOpt}};class Bucket{constructor(){this._b=[],this._css=void 0,this.rangeOurEffectApplyFn=stubFN,this.statePointerLow={value:void 0,index:void 0},this.statePointerHigh={value:void 0,index:void 0}}resetPointers(){this.statePointerLow={value:void 0,index:void 0},this.statePointerHigh={value:void 0,index:void 0}}setRangeOutEffect(e,t){this._css=e,this.rangeOurEffectApplyFn=t}addInBucket(e){var t,i=this._b,a=e.getColorValue(),o=0,l=i.length-1;a&&(t=function(){for(var e,r,n;o<=l;)if(t=e=0|(o+l)/2,r=i[e],n=r.getColorValue(),n<a)o=e+1;else if(n>a)l=e-1;else return e;return~l}(),i.splice(Math.abs(t),0,e))}moveLowerShadePointer(e){var t,i,a,o=this._b,l=this.statePointerLow,r=l.index,n=l.value,h=!1;if(t=r=void 0===r?0:r,n=void 0===n?Number.NEGATIVE_INFINITY:n,e!==n){if(n<=e){for(;i=o[t++],a=i?i.getColorValue():0,!(e<a)&&i;)h=!0,i.rangeOutEffect=this._css,this.rangeOurEffectApplyFn.call(i,this._css);t=h?t-2:t-1}else{for(;i=o[t--],a=i?i.getColorValue():0,!(e>=a)&&i;)i.cssConf=i.cssConf||{},h=!0,delete i.rangeOutEffect,i.cssConf.opacity=1,this.rangeOurEffectApplyFn.call(i,i.cssConf);t=h?t+2:t+1}l.index=t,l.value=e}}moveHigherShadePointer(e){var t,i,a,o=this._b,l=o.length,r=this.statePointerHigh,n=r.index,h=r.value,s=!1;if(t=n=void 0===n?l-1:n,h=void 0===h?Number.POSITIVE_INFINITY:h,e!==h){if(h>e){for(;i=o[t--],a=i?i.getColorValue():0,!(e>=a)&&i;)s=!0,i.rangeOutEffect=this._css,this.rangeOurEffectApplyFn.call(i,this._css);t=s?t+2:t+1}else{for(;i=o[t++],a=i?i.getColorValue():0,!(e<a)&&i;)i.cssConf=i.cssConf||{},s=!0,delete i.rangeOutEffect,i.cssConf.opacity=1,this.rangeOurEffectApplyFn.call(i,i.cssConf);t=s?t-2:t-1}r.index=t,r.value=e}}}class TreeNode{constructor(e,t,i){this.label=e,this.id=id++,this.value=parseFloat(t,10),this.colorValue=parseFloat(i,10),this.next=void 0,this.prev=void 0,this.meta={}}getCSSconf(){return this.cssConf}getPath(){return this.path}setPath(){var e=this,t=e.getParent();e.path=(t?t.getPath():[]).concat(e)}addChild(e){return e instanceof TreeNode&&(this.next=this.next||[],[].push.call(this.next,e),e.setParent(this)),this.next}getChildren(){return this.next}addChildren(e,t){var i=this,a=i.getChildren()||(i.next=[]),o=a.length;t||(t=o-1),t=t>o-1?o-1:0>t?0:t,a.splice(t,0,e),e.setParent(this)}getDepth(){return this.meta.depth}isLeaf(e){var t=this;return(!e||t.getDepth()<e)&&t.next}setParent(e){return e instanceof TreeNode&&(this.prev=e),this}getSiblingCount(e){var t,i=0,a=this,o=a;if(this instanceof TreeNode){if(t=a.getParent(),e){for(;o;)o=o.getSibling(e),o&&(i+=1);return i}return t?t.getChildren().length:void 0}}getParent(){return this.prev}getLabel(){return this.label}getValue(){return this.value}setValue(e,t){var i=this;t?i.value+=e:i.value=e}getColorValue(){return this.colorValue}getSibling(e){var t,i,a,o,l=e.toLowerCase(),r=this.getParent(),n=this.getLabel();if(r)for(t=r.getChildren(),i=0;i<t.length;i++)if(o=t[i],a=o.getLabel(),a===n)switch(l){case'left':return t[i-1];case'right':return t[i+1];}}setMeta(e,t){this.meta[e]=t}setDepth(e){this.meta.depth=e}getMeta(e){return e?this.meta[e]:this.meta}}export default ref;