import AnnotationShape from'./annotation-shape';import getEditableSructure from'./editable-properties';import{pluckNumber,pluck,setLineHeight,pluckFontSize,toRaphaelColor,getSuggestiveRotation,parseUnsafeString}from'./utils';const POSITION_BOTTOM='bottom',POSITION_TOP='top',POSITION_MIDDLE='middle',BOLD='bold',DEFAULT_RADIUS=0,DEFAULT_BORDER_PADDING=2,DEFAULT_BORDER_THICKNESS=1,DEFAULT_COLOR='#FF0000',DEFAULT_ALPHA=100,FULL_ANGLE_DEGREES=360,RADIAL='radial',DEFAULT_FILL_ANGLE=0,DEFAULT_FONT_SIZE=10,ITALIC='italic',NORMAL='normal',TEXT_ALIGN_OPTIONS={left:'start',right:'end',center:'middle'},TEXT_V_ALIGN_OPTIONS={top:'bottom',middle:'middle',bottom:'top'},TEXT_ROTATION_OPTIONS={0:'0',1:'270',right:'90',cw:'90',left:'270',ccw:'270'};function isValidColor(a){return /(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(a)?a:/(^[0-9A-F]{6}$)|(^[0-9A-F]{3}$)/i.test(a)&&'#'+a}class AnnotaionText extends AnnotationShape{_configureShape(a){let b=this,c=b.groupConfig;b.config.text=parseUnsafeString(pluck(a.text,a.label,'')),b.config.font=pluck(a.font,c.font,'Verdana, sans'),b.config.fontSize=pluckFontSize(a.fontSize,c.fontSize,DEFAULT_FONT_SIZE),b.config.align=pluck(TEXT_ALIGN_OPTIONS[a.align&&a.align.toLowerCase()],TEXT_ALIGN_OPTIONS[c.textAlign&&c.textAlign.toLowerCase()],'middle'),b.config.vAlign=pluck(TEXT_V_ALIGN_OPTIONS[a.vAlign&&a.vAlign.toLowerCase()],TEXT_V_ALIGN_OPTIONS[c.textVAlign&&c.textVAlign.toLowerCase()],'middle'),b.config.radius=pluckNumber(parseFloat(a.radius),DEFAULT_RADIUS),b.config.fontWeight=pluckNumber(a.bold,0)?BOLD:NORMAL,b.config.fontStyle=pluckNumber(a.italic,0)?ITALIC:NORMAL,b.config.bgColor=isValidColor(a.bgColor)?a.bgColor:'none',b.config.borderThickness=pluckNumber(parseFloat(b.rawConfig.borderThickness),parseFloat(b.rawConfig.thickness),DEFAULT_BORDER_THICKNESS),b.config.rotateText=pluck(a.rotateText,c.rotateText,'0'),b.config.rotateAngle=TEXT_ROTATION_OPTIONS[b.config.rotateText&&b.config.rotateText.toLowerCase()],b.config.wrap=pluckNumber(a.wrap,c.wrapText,a.wrapHeight,a.wrapWidth,1),b.config.wrap&&(b.config.wrapWidth=pluckNumber(a.wrapWidth),b.config.wrapHeight=pluckNumber(a.wrapHeight)),b.config.leftMargin=pluckNumber(a.leftMargin,0),b.config.elementType='text'}getEditorConfig(){let a=this,b=[{name:'id',value:a.config.id},{name:'text',value:a.config.text},{name:'font',value:a.config.font},{name:'fontSize',value:a.config.fontSize},{name:'bold',value:a.config.fontWeight===BOLD},{name:'italic',value:a.config.fontStyle===ITALIC},{name:'textBackground',value:a.config.bgColor?a.config.bgColor:''}];return getEditableSructure(b)}getText(){let a,b=this,c=b.config,d=b._getFromStore('smartLabel'),e=c.wrap,f=b._getFromStore('annotation-group'),g=f&&f._getConfig('scaleText'),h=g?b.getScaledVal(c.wrapWidth,!0):c.wrapWidth,i=g?b.getScaledVal(c.wrapHeight,!1):c.wrapHeight,j={fontStyle:c.fontStyle,fontFamily:c.font,fontWeight:c.fontWeight,fontSize:c.fontSize+'px',"text-anchor":c.align,"vertical-align":c.vAlign};return setLineHeight(j),d&&d.setStyle(j),a=d&&e?d.getSmartText(c.text,h,i,0).text:c.text,a}_getFillColor(a,b){let c=this,d=c.getType(),e={color:'',alpha:'',angle:'',ratio:'',radialGradient:'circle'===d||'arc'===d};return e.color=a.fontColor||a.fillColor||a.color||b.color||DEFAULT_COLOR,e.alpha=pluck(a.fillAlpha,parseFloat(a.alpha),b.alpha,DEFAULT_ALPHA),e.angle=FULL_ANGLE_DEGREES-pluckNumber(a.fillAngle,DEFAULT_FILL_ANGLE),e.ratio=pluck(a.fillRatio),a.fillPattern&&(e.radialGradient=a.fillPattern===RADIAL||pluckNumber(a.fillPattern)),e.radialGradient&&(e.gradientUnits='objectBoundingBox',e.cx=.5,e.cy=.5,e.fx=.5,e.fy=.5),c.config.rawColor=e.color,c.config.rawAlpha=e.alpha,c.config.rawAngle=e.angle,c.config.rawFillPattern=e.radialGradient?'radial':'linear',c.config.rawRatio=e.ratio,toRaphaelColor(e)}updateAttr(a){let b,c=this,d=c.config,e=pluckNumber(a.x,c.getScaledVal(d.x,!0)),f=pluckNumber(a.y,c.getScaledVal(d.y,!0));'0'!==d.rotateText&&(b=getSuggestiveRotation(parseFloat(d.rotateAngle),e,f)),c._setConfig('attr',{x:e,y:f,transform:b})}_getAnnotationAttrs(){let a=this,b=a.config,c=a._getConfig('attr')||{},d=a.getText(),e=a.getScaledVal(b.x,!0),f=a.getScaledVal(b.y,!1);return c.x=('undefined'==typeof c.x?e:c.x)+b.leftMargin/2,c.y='undefined'==typeof c.y?f:c.y,c.text=d,c.fill=b.color,c['text-bound']=[toRaphaelColor(b.bgColor),b.borderColor,b.borderThickness,DEFAULT_BORDER_PADDING,b.radius,b.dashArrayStr],c['font-style']=b.fontStyle,c['font-weight']=b.fontWeight,c['font-family']=b.font,c['font-size']=a.getScaledFont(b.fontSize),c['text-anchor']=b.align,c['vertical-align']=b.vAlign,'0'!==b.rotateText&&(c.transform=c.transform||getSuggestiveRotation(parseFloat(b.rotateAngle),e,f)),c}}export default AnnotaionText;