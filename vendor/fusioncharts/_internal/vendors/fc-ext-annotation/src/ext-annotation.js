import Annotation from'../vendors/fusioncharts-annotations/src/annotation-controller';import ComponentInterface from'../../../../core/component-interface';import pickBy from'ramda/src/pickBy';import{computePlotBounds,cleanMacro,pluck,computeSliceBounds,compute3DSliceBounds,arrangeItems,defaultAnnotationClick,defaultAnnotationRollOut,defaultAnnotationRollOver,DEFAULT_MACRO_PREFIX,DEFAULT_MACRO_SEPARATOR,xyCalculator,axisMacroParser,getLinkAction}from'./utils';import{addDep,getDep}from'../../../dependency-manager';import annotationAnimation from'./annotation-animation';import raphaelShapesRingpath from'../../../redraphael/redraphael-shapes/redraphael-shapes.ringpath';import raphaelShapesArcpath from'../../../redraphael/redraphael-shapes/redraphael-shapes.arcpath';const NO_ANIM_CONFIG={animDuration:0},circular2D=['pie2d','doughnut2d'],circular3D=['pie3d','doughnut3d'],scale={},isMacro=a=>~a.indexOf(DEFAULT_MACRO_PREFIX),solveEquation=a=>{var b=+a[0];for(let c,d,e=1,f=a.length;e<f;++e)d=a[e],e%2?c=d:'+'===c?b+=+d:'-'===c?b-=+d:void 0;return b},getSnapPoints=a=>{let b,c,d,e,f=a.config,g=a.getChildren(),h=g.caption[0],i=g.subCaption[0],j=g.legend&&g.legend[0]||{},k=g.gLegend&&g.gLegend[0]||{},l=h.config,m=i.config,n=l.width||0,o=m.width||0;return'end'===l.align?(b=l.x-n,d=l.x-o):'start'===l.align?b=d=l.x:(b=l.x-n/2,d=l.x-o/2),c=f.gLegendEnabled?k.conf:j.config,e={canvasendx:f.canvasRight,canvasendy:f.canvasBottom,canvasheight:f.canvasHeight,canvasstartx:f.canvasLeft,canvasstarty:f.canvasTop,canvaswidth:f.canvasWidth,canvascenterx:f.canvasCenterX||f.canvasLeft+(f.canvasRight-f.canvasLeft)/2,canvascentery:f.canvasCenterY||f.canvasTop+(f.canvasBottom-f.canvasTop)/2,chartcenterx:f.width/2,chartcentery:f.height/2,chartstartx:0,chartstarty:0,chartendx:f.width,chartendy:f.height,chartheight:f.height,chartwidth:f.width,chartleftmargin:f.marginLeft,chartrightmargin:f.marginRight,chartbottommargin:f.marginBottom,charttopmargin:f.marginTop,captionendx:b+l.width,captionendy:l.y+l.height,captionheight:l.height,captionstartx:b,captionstarty:l.y,captionwidth:n,subcaptionendx:d+m.width,subcaptionendy:m.y+m.height,subcaptionheight:m.height,subcaptionstartx:d,subcaptionstarty:m.y,subcaptionwidth:o,legendendx:c&&c.xPos+c.width,legendendy:c&&c.yPos+c.height,legendheight:c&&c.height,legendstartx:c&&c.xPos,legendstarty:c&&c.yPos,legendwidth:c&&c.width,dataset:function(b){let c,d,e,f=b.split(DEFAULT_MACRO_SEPARATOR).slice(1),g=[],h=[];return a.iterateComponents(function(a){'dataset'===a.getType()&&h.push(a)}),h.sort((c,a)=>c.getJSONIndex()-a.getJSONIndex()),d=h[+f[0]],g=d.components.data,c=g[+f[2]],-1<circular2D.indexOf(d.getName().toLowerCase())?computeSliceBounds(f[3],c.config):-1<circular3D.indexOf(d.getName().toLowerCase())?compute3DSliceBounds(f[3],c.config):(e=computePlotBounds(c,d.getName()),xyCalculator(f[3],e))},xaxis:axisMacroParser(a,'xAxis'),yaxis:axisMacroParser(a,'yAxis'),gaugestartx:f.gaugeStartX,gaugestarty:f.gaugeStartY,gaugeendx:f.gaugeEndX,gaugeendy:f.gaugeEndY,gaugecenterx:f.gaugeCenterX,gaugecentery:f.gaugeCenterY,gaugestartangle:f.gaugeStartAngle,gaugeendangle:f.gaugeEndAngle,gaugeradius:f.gaugeRadius,plotwidth:f.plotWidth,plotsemiwidth:f.plotSemiWidth},e},getScaledVal=a=>{let b;switch(scale.axis){case'x':case'toX':b=scale.scaleX;break;case'y':case'toY':b=scale.scaleY;break;default:b=scale.scaleValue||1;}return a*b},parseEquation=(a,b,c=!1,d=DEFAULT_MACRO_PREFIX)=>{let e,f,g,h,k,l,m=a.split(/([+])/),n=[],o=m.length;for(f=0;f<o;f++)if(h=m[f],'+'!==h){for(h=m[f],e=h.split(/([-])/),(g=0,l=e.length);g<l;g++)k=e[g],'-'!==k&&(n.push(e[g]),g<l-1&&n.push('-'));f<o-1&&n.push('+')}return n.map(a=>{let e,f,g,h='',i='',j='';if(a.charAt(0)===d){if(i=a.replace(/[\$ ]/g,''),j=i.split(DEFAULT_MACRO_SEPARATOR)[0],!isNaN(+i))return+i;for(h in b)if(j===h){if(f=new RegExp(h,'g'),'function'==typeof b[h])try{e=j.replace(f,b[h](i))}catch(a){e=j.replace(f,0)}else e=j.replace(f,b[h]||0);break}}else g=+a,isNaN(g)?'+'!==a&&'-'!==a&&(a=0):a=c?getScaledVal(g).toString():g.toString(),e=a;return e})},parseAndCalculateMacro=function(a,b){let c,d=this.config,e={x:pluck(a.x,a.xPos,0),y:pluck(a.y,a.yPos,0),toX:pluck(a.toX),toY:pluck(a.toY)},f={};for(var g in e)e.hasOwnProperty(g)&&(c=e[g],'undefined'!=typeof c&&(c=c.toString(),scale.axis=g,isMacro(c)?f[g]=solveEquation(parseEquation(cleanMacro(c.toLowerCase()),b,!0)):(f[g]=solveEquation(parseEquation(cleanMacro(c.toLowerCase()),b)),f[g]=getScaledVal(f[g]))));return f},parseAndSetAttribute=function(a,b){let c,d,e,f,g,h,k,l,m,n,o,p,q=a.getChildren(),r=q.annotation&&q.annotation[0]||b;if(r)for(c=r.annotation,d=getSnapPoints(a),m=c.groups&&c.groups.length,e=0;e<m;e++)for(g=c.groups[e],h=g.rawConfig,scale.scaleX=g._getConfig('scaleX'),scale.scaleY=g._getConfig('scaleY'),scale.scaleValue=g._getConfig('scaleValue'),o=parseAndCalculateMacro.call(g,h,d),g.updateAttr(o),o.x=o.x||0,o.y=o.y||0,n=g.items&&g.items.length,f=0;f<n;f++)k=g.items[f],l=k.rawConfig,p=parseAndCalculateMacro.call(k,l,d),p.x+=o.x,p.y+=o.y,isNaN(+p.toX)?p.toX=p.x:p.toX+=o.x,isNaN(+p.toY)||(p.toY+=o.y),k.updateAttr(p)},getBoolean=a=>0!==parseInt(a,10),parseShapeConfiguration=(a,b={},c={})=>{let d={annotationType:'shape',id:a.id,type:a.type&&a.type.toLowerCase(),toolText:pluck(a.tooltext,a.toolText),animationLabel:pluck(a.animationlabel,a.animationLabel),dashed:a.dashed,dashLen:pluck(a.dashlen,a.dashLen),dashGap:pluck(a.dashgap,a.dashGap),thickness:a.thickness,showBorder:pluck(a.showborder,a.showBorder),borderColor:pluck(a.bordercolor,a.borderColor),borderAlpha:pluck(a.borderalpha,a.borderAlpha),borderThickness:pluck(a.borderthickness,a.borderThickness),alpha:a.alpha,color:a.color,fillColor:pluck(a.fillcolor,a.fillColor),fontColor:pluck(a.fontcolor,a.fontColor),fillAlpha:pluck(a.fillalpha,a.fillAlpha),fillAngle:pluck(a.fillangle,a.fillAngle),fillRatio:pluck(a.fillratio,a.fillRatio),fillPattern:pluck(a.fillpattern,a.fillPattern),sides:a.sides,radius:a.radius,yRadius:pluck(a.yradius,a.yRadius),innerRadius:pluck(a.innerradius,a.innerRadius),endAngle:pluck(a.endangle,a.endAngle),startAngle:pluck(a.startangle,a.startAngle),isVisible:!0===getBoolean(a.visible),x:a.x,y:a.y,xPos:pluck(a.xpos,a.xPos),yPos:pluck(a.ypos,a.yPos),toY:pluck(a.toy,a.toY),toX:pluck(a.tox,a.toX),path:a.path,css:a.css,wrap:a.wrap,text:a.text,font:pluck(a.font,b.font,c.basefont),bold:pluck(a.bold,a.isbold,a.bold,a.isBold),label:a.label,align:a.align,italic:a.italic,vAlign:pluck(a.valign,a.vAlign),bgColor:pluck(a.bgcolor,a.bgColor),fontSize:pluck(a.fontsize,a.fontSize,b.fontSize,c.basefontsize),wrapWidth:pluck(a.wrapwidth,a.wrapWidth),leftMargin:pluck(a.leftmargin,a.leftMargin),rotateText:pluck(a.rotatetext,a.rotateText),wrapHeight:pluck(a.wrapheight,a.wrapHeight),showShadow:pluck(a.showshadow,a.showShadow),link:a.link,url:a.url,link:a.link,width:a.width,height:a.height,xScale:pluck(a.xscale,a.xScale),yScale:pluck(a.yscale,a.yScale),onload:a.onload,onerror:a.onerror};for(let e in d)if(d.hasOwnProperty(e)){let a=d[e];'undefined'==typeof a&&delete d[e]}return d},parseConfiguration=(a,b)=>{let c={},d=a.items;for(let e in d=a.items=arrangeItems(d),c.annotationType='group',c.id=a.id,c.showBelow='undefined'==typeof a.showbelow||null==a.showbelow?1:+a.showbelow,c.x=a.x,c.y=a.y,c.animationLabel=pluck(a.animationlabel,a.animationLabel),c.xPos=pluck(a.xpos,a.xPos),c.yPos=pluck(a.ypos,a.yPos),c.grpXShift=pluck(a.grpxshift,a.grpXShift),c.grpYShift=pluck(a.grpyshift,a.grpYShift),c.xShift=pluck(a.xshift,a.xShift),c.yShift=pluck(a.yshift,a.yShift),c.color=a.color,c.alpha=a.alpha,c.isVisible=1===+(a.visible||1),c.font=pluck(a.font,b.basefont),c.link=a.link,c.fontSize=pluck(a.fontsize,a.fontSize,b.basefontsize),c.textAlign=pluck(a.textalign,a.textAlign),c.textVAlign=pluck(a.textvalign,a.textVAlign),c.rotateText=pluck(a.rotatetext,a.rotateText),c.wrapText=pluck(a.wraptext,a.wrapText),c.toolText=pluck(a.tooltext,a.toolText),c.link=a.link,c.showShadow=pluck(a.showshadow,a.showShadow),c.items=a.items,c.css=a.css,c.autoScale=pluck(a.autoscale,a.autoScale),c.scaleText=pluck(a.scaletext,a.scaleText),c.xScale=pluck(a.xscale,a.xScale),c.yScale=pluck(a.yscale,a.yScale),c.scaleImages=pluck(a.scaleimages,a.scaleImages),c.constrainedScale=pluck(a.constrainedscale),c.origH=pluck(a.origh,a.origH,b.origh),c.origW=pluck(a.origw,a.origW,b.origw),c.onAnnotationClick=a.onAnnotationClick,c.onAnnotationRollover=a.onAnnotationRollover,c.onAnnotationRollout=a.onAnnotationRollout,c)if(c.hasOwnProperty(e)){let a=c[e];'undefined'==typeof a&&delete c[e]}return Array.isArray(d)&&(c.itemConfigs=d.map(function(a){return parseShapeConfiguration(a,c,b)})),c},attachEventOnElement=(a,b,c)=>{let d,e,f,g=a._getFromStore('element');a&&g&&(d=c.onAnnotationClick||defaultAnnotationClick(a,b),e=c.onAnnotationRollover||defaultAnnotationRollOver(a,b),f=c.onAnnotationRollout||defaultAnnotationRollOut(a,b),g.on('fc-click',d),g.on('fc-mouseover',e),g.on('fc-mouseout',f))},makeVisible=a=>{a.forEach(a=>{let b=a.items;b.forEach(a=>{a.config.isVisible=!0,a.show(NO_ANIM_CONFIG)}),a.config.isVisible=!0,a.show(NO_ANIM_CONFIG)})},mergeConfig=(a,b)=>{b.css=b.css||a.css,b.autoscale=pluck(b.autoscale,a.autoscale),b.animationLabel=pluck(b.animationLabel,a.animationLabel),b.constrainedscale=pluck(b.constrainedscale,a.constrainedscale),b.scaletext=pluck(b.scaletext,a.scaletext),b.scaleimages=pluck(b.scaleimages,a.scaleimages),b.xshift=pluck(b.xshift,a.xshift),b.yshift=pluck(b.yshift,a.yshift),b.grpxshift=pluck(b.grpxshift,a.grpxshift),b.grpyshift=pluck(b.grpyshift,a.grpyshift),b.origw=pluck(b.origw,a.origw),b.origh=pluck(b.origh,a.origh),b.showbelow=pluck(b.showbelow,a.showbelow,1),b.onAnnotationClick=a.onAnnotationClick,b.onAnnotationRollover=a.onAnnotationRollover,b.onAnnotationRollout=a.onAnnotationRollout},isRootGroupConfig=(a,b)=>'itemConfigs'!==b;addDep({name:'annotationAnimation',type:'animationRule',extension:annotationAnimation});class AnnotationExtension extends ComponentInterface{constructor(a={}){super(),this.annotation=new Annotation(a),this.idCounterStore={},this.rawConfig=JSON.parse(JSON.stringify(a)),this.config={}}getName(){return'annotation'}getType(){return'extension'}configureAttributes(a={groups:[]}){let b=this,c=b.getFromEnv('chart'),d=c.getFromEnv('dataSource');b.rawConfig={group:[]},b.config.labelClickFN=getLinkAction(d,c),b.rawConfig.macroEnabled=a.macroEnabled,b.parsedConfigs||(b.parsedConfigs=[]),this.parsedConfigs=a.groups?a.groups.map(b=>(mergeConfig(a,b),parseConfiguration(b,c.config))):[],b.createAnnotationItems()}createAnnotationItems(){let a=this,b=a.getFromEnv('chartInstance');a.parsedConfigs.forEach(c=>{let d,e,f=c.itemConfigs||{},g=a.annotation;c=pickBy(isRootGroupConfig,c),c.chartWidth=+b.width,c.chartHeight=+b.height,e={x:c.x,y:c.y,toX:c.toX,toY:c.toY,items:[]},a.rawConfig.group.push(e),d=g.createItem(c),f.forEach(a=>{a.chartWidth=+b.width,a.chartHeight=+b.height,e.items.push({x:a.x,y:a.y,toX:a.toX,toY:a.toY}),g.createItem(a,d)})})}getGraphicalElement(){return{itemElements:this.annotation.items.map(a=>a._getFromStore('element'))}}getChildContainer(){return{groupElements:this.annotation.groups.map(a=>a._getFromStore('element'))}}addItem(a,b={},c,d){let e,f=this.annotation.retrieveGroup(a),g=this.getFromEnv('chart'),h=parseShapeConfiguration(b);if(h.hasTemporaryInvisibility=!1,h.isVisible=!0,f=f||this.addGroup({id:a}),e=this.annotation.createItem(h,f),!!e)return this.annotation.injectDependency('component',d),this.annotation.attachModule(e),parseAndSetAttribute(g),f._getFromStore('element')||f._draw(),this.annotation.drawItem(e,f._getFromStore('element')),attachEventOnElement(e,g,f.rawConfig),e}addGroup(a={},b){return this.configureAttributes({groups:[a]}),this.annotation.injectDependency('component',b),this.draw(),makeVisible(this.annotation.groups),this.annotation.groups[this.annotation.groups.length-1]}addCustomGroup(a){a&&(this.config.customGroup=a)}update(a,b){let c,d,e,f,g,h={},j=this.annotation;if(a){for(d in b)h[d.toLowerCase()]=b[d]&&b[d].toString();if(c=this.annotation.retrieveItem(a)||this.annotation.retrieveGroup(a),!c||!c._getFromStore('element'))return;for('undefined'==typeof h.visible&&(h.visible=c._getConfig('isVisible')),g=parseShapeConfiguration(h),g.isVisible=h.visible,c&&c.setAttribute(g),'group'===c.config.elementType&&c.updateScale(),parseAndSetAttribute(this.getFromEnv('chart'),this),j.drawItem(c,c._getFromStore('groupElement')),!1!==b.visible&&c.show(),c._getFromStore('animationManager').setAnimation({el:c._getFromStore('element'),attr:c.config.attr,component:c._getFromStore('component'),label:pluck(c.rawConfig.animationLabel,c.config.elementType)}),e=c.items||[],f=0;f<e.length;f++)e[f]&&j.drawItem(e[f],e[f]._getFromStore('groupElement'));return c}}hide(a){let b;a?(b=this.annotation.retrieveItem(a)||this.annotation.retrieveGroup(a),b&&b.hide(NO_ANIM_CONFIG)):this.annotation.hide(NO_ANIM_CONFIG)}show(a){let b;a?(b=this.annotation.retrieveItem(a)||this.annotation.retrieveGroup(a),b&&b.show(NO_ANIM_CONFIG)):this.annotation.show(NO_ANIM_CONFIG)}destroy(a){let b;a?(b=this.annotation.retrieveItem(a)||this.annotation.retrieveGroup(a),b&&b.dispose(NO_ANIM_CONFIG,!0)):this.annotation.dispose(NO_ANIM_CONFIG,!0)}_dispose(){this.destroy()}clear(){let a;for(a=this.parsedConfigs&&this.parsedConfigs.length;a--;)this.parsedConfigs.pop();for(a=this.rawConfig.group&&this.rawConfig.group.length;a--;)this.rawConfig.group.pop();delete this.rawConfig.group,this.annotation.dispose(NO_ANIM_CONFIG,!0)}updateScale(){let a,b,c,d=this,e=d.annotation;for(c=e.groups&&e.groups.length,a=0;a<c;a++)b=e.groups[a],b.updateScale()}injectAllDependency(){let a,b,c,d,e,f,g,h=this,k=h.annotation,l=h.getFromEnv('chart'),m=k.resolveDependency('component')||h,n=getDep('redraphael','plugin');for(raphaelShapesRingpath(n),raphaelShapesArcpath(n),g={width:+l.getFromEnv('chartWidth'),height:+l.getFromEnv('chartHeight')},k.injectDependency('paper',g),k.injectDependency('smartLabel',h.getFromEnv('smartLabel')),k.injectDependency('toolTipController',h.getFromEnv('toolTipController')),k.injectDependency('animationManager',h.getFromEnv('animationManager')),k.injectDependency('component',m),k.injectDependency('clickFN',h.config.labelClickFN),e=k.groups&&k.groups.length,a=0;a<e;a++)for(c=k.groups[a],k.attachModule(c),d=c.items,f=d&&d.length,b=0;b<f;b++)k.attachModule(d[b])}draw(){let a=this,b=a.getFromEnv('chart'),c=a.annotation;a.injectAllDependency(),a.updateScale(),a.rawConfig.macroEnabled&&parseAndSetAttribute(b),a.drawAnnotationItems(a),a.config.drawn=!0}drawAnnotationItems(){let a,b,c,d,e,f,g,h=this,k=h.getFromEnv('chart'),l=h.annotation;for(a=l.groups&&l.groups.length,c=0;c<a;c++)for(b=l.groups[c],g=h.config.customGroup?h.config.customGroup:b.rawConfig.showBelow?h.getLinkedParent().getChildContainer('lowerAnnotationGroup'):h.getLinkedParent().getChildContainer('upperAnnotationGroup'),l.drawItem(b,g),e=b.items,f=e&&e.length,g=b._getFromStore('element'),d=0;d<f;d++)l.drawItem(e[d],g),attachEventOnElement(e[d],k,b.rawConfig)}}export default AnnotationExtension;